---
layout: single
title: "ZFS and NFS for Forensic Storage Servers"
date: '2012-08-03T06:53:00.002+09:00'
author: Joshua
tags:
- Storage
- HowTo
modified_time: '2015-08-24T22:35:19.255+09:00'
thumbnail: http://4.bp.blogspot.com/-bExEn2zM4fY/UBr1OZH3avI/AAAAAAAAAnA/wGixsovwLUA/s72-c/ID-10041809.jpg
blogger_id: tag:blogger.com,1999:blog-2701259639305045003.single-6004462241963275631
blogger_orig_url: https://DFIR.Science/2012/08/zfs-and-nfs-for-forensic-storage-servers.html
---

<a href="http://4.bp.blogspot.com/-bExEn2zM4fY/UBr1OZH3avI/AAAAAAAAAnA/wGixsovwLUA/s1600/ID-10041809.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="150" src="http://4.bp.blogspot.com/-bExEn2zM4fY/UBr1OZH3avI/AAAAAAAAAnA/wGixsovwLUA/s200/ID-10041809.jpg" width="200" /></a>We've been looking at different storage solutions to act as storage servers for forensic images, and some extracted data. Essentially we have a server with eight 3TB drives, and one 40GB flash drive. RAID cards are RAIDCore BC4000 series and another HighPoint RocketRAID 272x series. The RIADCore, we have been unable to get working in either <a href="http://www.freenas.org/">FreeNAS</a>&nbsp;8 or <a href="http://www.ubuntu.com/" target="_blank">Ubuntu</a> 12.04. It does, however, give the OS direct access to the connected drives if they are not RAIDed. The HighPoint works with Ubuntu 10.04 (kernel 2.6), and works with the newest version of FreeNAS (BSD driver). Though with FreeNAS I have had drives somehow fall out of a zfs pool, and not be able to be re-added. HighPoint also gives the OS direct access to the connected drives if they are not RAIDed.<br /><br />So, since we were having trouble with the hardware RAID, we decided to look for alternatives. The ideal solution would&nbsp;aggregate&nbsp;all the storage across 4 servers into one volume. So initially we considered using sharing each of the physical disks via iSCSI, then having some single-head initiator to access them all. The initiator would the be responsible for some type of software RAID, LVM and sharing the &nbsp;NFS mount point. Connectivity and data redundancy are big issues, and I was worried with this method, if one of the servers drops out a lot of data may be lost or corrupted, plus the head may be a bottleneck.<br /><br />Instead, we decided that each server would host its own NFS share, so we just needed a way to combine all the 3TB physical disks into one large volume. I thought first about a software RAID+ext4, but instead decided to try <a href="http://en.wikipedia.org/wiki/ZFS" target="_blank">ZFS</a>. It seemed to have the redundancy we were looking for, plus some other interesting features, such as taking care of NFS from ZFS.<br /><br />For ZFS we decided to try both Ubuntu and FreeNAS (BSD) to figure out 1) which is faster and 2) which is easier to setup and administer.<br /><br />After installing Ubuntu 12.04, and following <a href="http://www.servercobra.com/freenas-to-ubuntu-initial-fileserver-setup-with-zfs/" target="_blank">these instructions</a>&nbsp;with a bit of help from <a href="http://zfsonlinux.org/faq.html" target="_blank">here</a>, we had&nbsp;terabytes&nbsp;of&nbsp;aggregate&nbsp;storage accessible over NFS in about 15 minutes. Pretty easy.<br /><br />Then we started trying to image to the share. From a USB device to the server using Guymager, we could image about 11-13MB/sec. After 30 to 40 seconds of imaging, all the drives in the zpool would start flashing like crazy, and imaging would drop to around 3MB/sec. Faster initial speeds, but similar&nbsp;degradation&nbsp;happened with eSATA/IDE drives on the acquisition machine.<br /><br />[edit] I&nbsp;believe&nbsp;part of the problem was with NFS having the 'sync' flag set on the server-side. I had less&nbsp;degradation&nbsp;and slightly faster performance with 'async'.<br /><br />So, for large files ZFS was quite slow. This did NOT seem to be the case when writing from the server to the local zpool, which leads me to think it might be partially a problem with NFS (which zfs handles itself with the 'zfs set sharenfs=on ... ' command). I think the initial high speed is because of caching. So now I am wondering if ZFS is meant for bursts of smaller reads and writes rather than writing large files.<br /><br />Looking around for why ZFS seems degrade so much, I found <a href="http://icesquare.com/wordpress/how-to-improve-zfs-performance/#section8" target="_blank">this article</a>, which claims to improve ZFS performance. NOTE: if you make any of the changes from the article, make sure you have a backup of your data. I found that after making some of the tweaks, my pool had been corrupted and had to be re-created. The tweaks did seem to make the server more stable over time (less freezing), but write speeds still degraded.<br /><br />FreeNAS took much less time than Ubuntu to install, and as long as it can detect your disks, creation of a new pool and sharing the pool takes about 10 clicks of your mouse (from the web interface).&nbsp;ZFS on FreeNAS appears to be less stable that on Ubuntu (we had drives drop out, and a more freezing), but we are getting write speeds of approximately 15MB/sec with less - but some - degradation&nbsp;over time.<br /><br />To see if the slow write speed is ZFS related, we&nbsp;are currently building a <a href="http://en.wikipedia.org/wiki/Mdadm" target="_blank">software array</a>, and will just format it with ext4, and create a standard NFS share. Syncing the 8 disks in the array will take hours, but after hopefully we will have much, much better transfer speeds. Ubuntu allows the creation of a software array on install, which makes it very easy to set up.<br /><br />If you have any experience with ZFS, and know what some of the issues might be, or even just a better set-up for&nbsp;aggregating&nbsp;large disks and getting good performance writing large files, please leave a comment. <br /><br /><a class="addthis_button" href="http://www.addthis.com/bookmark.php?v=250&amp;pubid=xa-50106e2f4b1c5322"><img alt="Bookmark and Share" height="16" src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" style="border: 0;" width="125" /></a><script src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-50106e2f4b1c5322" type="text/javascript"></script><br /><span style="font-size: small;">Image: <a href="http://www.freedigitalphotos.net/" target="_blank">FreeDigitalPhotos.net</a></span>