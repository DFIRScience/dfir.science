---
layout: single
title: "Debian: Building a Custom Kernel with live-helper"
date: '2009-03-23T05:25:00.000+09:00'
author: Joshua
tags: 
modified_time: '2012-06-17T06:50:43.079+09:00'
blogger_id: tag:blogger.com,1999:blog-2701259639305045003.single-8654439921005122796
blogger_orig_url: https://DFIR.Science/2009/03/debian-building-custom-kernel-with-live.html
---

<pre>Taken directly from: <a href="http://lists.alioth.debian.org/pipermail/debian-live-devel/2008-April/003456.html">lists.alioth.debian.org</a><br /><br />This is a little HOWTO about compile and use a custom kernel with<br />live-helper. After some issues, our CDs works so we decides to provides<br />this help here. Sorry if it's not the better way to do / better place<br />to purpose.<br /><br />We are assuming that we use the kernel version 2.6.24. and we have<br />tested on Lenny with live-helper_1.0~a41.<br /><br />Required: module-assistant, gcc, libncurses-dev (optionnal)<br />linux-source-2.6.24<br /><br /><br /><br />1a) First, we need to fetch the kernel sources.<br />------------------------------------------------------------------<br /># aptitude install kernel-source-2.6.24<br />------------------------------------------------------------------<br />Sources are fetched in  /usr/src/linux-source-2.6.24.tar.bz2<br /><br />1b) Using vanilla sources should work too<br />------------------------------------------------------------------<br /># wget <a href="http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.24.tar.bz2">http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.24.tar.bz2</a><br />------------------------------------------------------------------<br /><br /><br />2) Extract sources<br />------------------------------------------------------------------<br /># cd /usr/src<br /># tar -xjf linux-source-2.6.24.tar.bz2<br />------------------------------------------------------------------<br /><br /><br />3) Configure the kernel<br />Switch to the sources directory.<br />------------------------------------------------------------------<br /># cd linux-source-2.6.24<br />------------------------------------------------------------------<br /><br /><br />3a) with menuconfig (you will need libncurses-dev)<br />------------------------------------------------------------------<br /># make menuconfig<br />------------------------------------------------------------------<br />Note: don't forget to save configuration<br /><br />3b) You can also use the debian/ubuntu configuration, and work from it.<br />Configurations are usually stored in /boot and come with the<br />linux-image-* packages.<br />------------------------------------------------------------------<br /># cp /boot/config-2.6.24 ./.config<br /># make menuconfig (optionnal)<br />------------------------------------------------------------------<br /><br /><br />4) Build the kernel packages<br />Important: we need to append something something in our kernel version,<br />it will help avoiding conflits with the debian / ubuntu kernels and<br />select our kernel in the syslinux menu. It can be everything with<br />letters and numbers, like -foobar. in this howto, we will use -dlb.<br />Don't forget to add a revision too, it will be usefull for updates:<br />------------------------------------------------------------------<br /># fakeroot make-kpkg --initrd --revision=dlb.1.0 \<br />--append-to-version=-dlb kernel_image kernel_headers modules<br />------------------------------------------------------------------<br /><br /><br />5) Build the modules packages<br />We need to download some sources in order to get the live cd working.<br />We need the lzma, squashfs and aufs modules.<br />------------------------------------------------------------------<br /># aptitude install lzma-source squashfs-source aufs-source<br />------------------------------------------------------------------<br /><br />Prepare work<br />------------------------------------------------------------------<br /># cd /usr/src<br />------------------------------------------------------------------<br /><br />In most cases, we don't need this link, but It can help with broken<br />packages.<br />------------------------------------------------------------------<br /># rm -rf /usr/src/linux<br />------------------------------------------------------------------<br /><br />link your source directory to /usr/src/linux<br />------------------------------------------------------------------<br /># ln -s linux-source-2.6.24 linux<br />------------------------------------------------------------------<br /><br />build the modules with module-assistant<br />------------------------------------------------------------------<br /># m-a update<br /># m-a build -k /usr/src/linux-source-2.6.24 lzma<br /># m-a build -k /usr/src/linux-source-2.6.24 squashfs<br /># m-a build -k /usr/src/linux-source-2.6.24 aufs<br />------------------------------------------------------------------<br /><br />6) Install the packages into our lh directory.<br />At this point, you should have some packages in /usr/src<br />Here is our /usr/src<br />------------------------------------------------------------------<br />debian:~#<br />ls /usr/src/<br />aufs-modules-2.6.24-dlb_0+20080129-1+dlb.1.0_i386.deb<br />aufs.tar.bz2<br />linux-&gt;linux-source-2.6.24<br />linux-headers-2.6.24-dlb_dlb.1.0_i386.deb<br />linux-image-2.6.24-dlb_dlb.1.0_i386.deb<br />linux-source-2.6.24<br />linux-source-2.6.24.tar.bz2<br />lzma-modules-2.6.24-dlb_4.43-12+dlb.1.0_i386.deb<br />lzma.tar.bz2<br />modules<br />squashfs-modules-2.6.24-dlb_3.3-3+dlb.1.0_i386.deb<br />squashfs.tar.bz2<br />------------------------------------------------------------------<br /><br />Change to our live-helper directory<br />------------------------------------------------------------------<br />cd /home/user/LIVECD/<br />lh_config --syslinux-menu enabled # Plus eventually options<br />cp -v /usr/src/*.deb config/chroot_local-packages/<br />------------------------------------------------------------------<br /><br />7) Configure live helper<br />Edit config/root with your favorite text editor. to avoid vi/emacs<br />trolls, we will use nano. =)<br />------------------------------------------------------------------<br /># nano config/chroot<br />------------------------------------------------------------------<br /><br />set LH_LINUX_PACKAGES="none"<br />set LH_LINUX_FLAVOURS="dlb"<br />where dlb is the "append-to-version" from the step 3 without the first<br />dash.<br /><br />Don't forget to add "--syslinux-menu enabled" to lh_config<br /><br />Now you can lh_build your live CD/USB key and everything should be ok.</pre>