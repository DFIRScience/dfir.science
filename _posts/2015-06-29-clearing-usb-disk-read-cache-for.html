---
layout: posts
title: Clearing USB disk read cache for testing and forensics in Linux
date: '2015-06-29T16:39:00.000+09:00'
author: Joshua
tags:
- Linux
- Hashing
- HowTo
modified_time: '2015-08-24T22:35:19.297+09:00'
thumbnail: http://2.bp.blogspot.com/-r1yKgmrFg3I/VZDyu07b-CI/AAAAAAAAA9s/u5o5NWRxQSE/s72-c/tux-158547_1280.png
blogger_id: tag:blogger.com,1999:blog-2701259639305045003.single-6541635557967291160
blogger_orig_url: https://DFIR.Science/2015/06/clearing-usb-disk-read-cache-for.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-r1yKgmrFg3I/VZDyu07b-CI/AAAAAAAAA9s/u5o5NWRxQSE/s1600/tux-158547_1280.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://2.bp.blogspot.com/-r1yKgmrFg3I/VZDyu07b-CI/AAAAAAAAA9s/u5o5NWRxQSE/s200/tux-158547_1280.png" width="194" /></a></div><br />When copying data from USB devices in Linux (Debian / Ubuntu), you may have noticed that reading data from the disk the first time takes a while, and reading the second time takes only a few seconds.<br /><div><br /></div><div>For example:</div><div><br /></div><pre>joshua@Apollo /media/joshua/ucdntfs $ time sudo md5sum /dev/sdf1<br />3a698f0c3155e494274e5e7829f4d246  /dev/sdf1<br /><br />real 2m58.620s<br />user 0m7.032s<br />sys 0m1.429s<br /><br />joshua@Apollo /media/joshua/ucdntfs $ time sudo md5sum /dev/sdf1<br />3a698f0c3155e494274e5e7829f4d246  /dev/sdf1<br /><br />real 0m3.467s<br />user 0m3.285s<br />sys 0m0.181s<br /></pre><br />Here the first read took 2 minutes 58 seconds, while the second took only 3 seconds.This is because all data on the disk is cached to memory when read the first time. In cases where the disk may change between reads, caching may return results that are not consistent with the current state of the disk (like a hash).<br /><br />When looking how to disable read cache, I found a lot of information about disabling <b>write</b>&nbsp;cache, but not a lot about disabling read.<br /><br />To disable <b>write</b>&nbsp;cache (if supported) for the current session that the device is plugged in:<br /><br /><pre>sudo hdparm -W 0 /dev/[device]<br /></pre><br />But this does not solve our read cache problems. Unfortunately, I could not find a way to completely disable read cache, but we can clear the cache buffer.<br /><br />First, determine the path to echo with <br /><br /><pre>which echo</pre><br />Then we want to tell the <a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt" target="_blank">kernel to drop caches</a>. To do this, we need to echo a value to /proc/sys/vm/drop_caches.<br /><blockquote class="tr_bq"><pre style="white-space: pre-wrap; word-wrap: break-word;">To free pagecache:<br /> echo 1 &gt; /proc/sys/vm/drop_caches<br />To free reclaimable slab objects (includes dentries and inodes):<br /> echo 2 &gt; /proc/sys/vm/drop_caches<br />To free slab objects and pagecache:<br /> echo 3 &gt; /proc/sys/vm/drop_caches</pre></blockquote><br />So our echo command to clear all caches should look like:<br /><br /><pre>sudo sh -c "/bin/echo 3 &gt; /proc/sys/vm/drop_caches"<br /></pre><br /><b>Note: </b>You probably cannot echo directly to drop_caches with sudo - you should be root. The work-around to that is <a href="https://unix.stackexchange.com/questions/109496/echo-3-proc-sys-vm-drop-caches-permission-denied-as-root" target="_blank">wrap the whole command in sudo</a>. Make sure you are putting the full path to echo on your system.<br /><br /><pre>joshua@Apollo /media/joshua/ucdntfs $ time sudo md5sum /dev/sdf1<br />3a698f0c3155e494274e5e7829f4d246  /dev/sdf1<br /><br />real 3m18.294s<br />user 0m6.389s<br />sys 0m1.390s<br /><br />joshua@Apollo /media/joshua/ucdntfs $ sudo sh -c "/bin/echo 3 &gt; /proc/sys/vm/drop_caches"<br /><br />joshua@Apollo /media/joshua/ucdntfs $ time sudo md5sum /dev/sdf1<br />3a698f0c3155e494274e5e7829f4d246  /dev/sdf1<br /><br />real 3m18.344s<br />user 0m6.545s<br />sys 0m1.438s<br /></pre><br />If you use it a lot, like me, you might want to make an alias:<br /><br /><pre>alias clearusbcache="sudo sh -c '/bin/echo 3 &gt; /proc/sys/vm/drop_caches'"<br /></pre><br />If you want to clear the cache in the background while running experiments, you can try <a href="https://www.linuxquestions.org/questions/linux-kernel-70/how-to-disable-filesystem-cache-627012/" target="_blank">this</a>&nbsp;script:<br /><br /><pre>#!/bin/bash<br />while true; do<br />   /bin/echo 3 &gt; /proc/sys/vm/drop_caches<br />   sleep 1<br />done<br /></pre>